#!/usr/bin/env python3

import signal
import os, sys
from cheroot import wsgi
from nwrsc import create_app

server = None

def removepid(signum, frame):
    global server
    if server:
        server.stop()
    os.remove(pidfile)
    sys.exit(0)

if __name__ == '__main__':
    theapp = create_app()
    port = theapp.config['PORT']
    pidfile = os.path.join(theapp.config['INSTALLROOT'], 'logs', 'webserver.pid')

    signal.signal(signal.SIGABRT, removepid)
    signal.signal(signal.SIGINT,  removepid)
    signal.signal(signal.SIGTERM, removepid)
    with open(pidfile, 'w') as fp:
        fp.write(str(os.getpid()))

    if theapp.debug:
        theapp.run(host='0.0.0.0', port=port, threaded=True)
    else:
        server = wsgi.Server(('0.0.0.0', port), theapp, numthreads=60, shutdown_timeout=1, server_name="Scorekeeper 2.0")
        server.start()

    removepid(0, 0) # just in case we get here somehow

